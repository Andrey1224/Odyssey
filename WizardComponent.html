import React, { useState, useEffect } from 'react';
import { 
  Users, User, Armchair, Bed, 
  Accessibility, Box, ArrowRight, 
  ArrowLeft, Phone, CheckCircle, HelpCircle,
  Star, X, ChevronRight, Menu
} from 'lucide-react';

/* =============================================================================
  СТИЛИ АНИМАЦИЙ (CSS)
  Мы добавляем их сюда, чтобы они работали без плагинов tailwindcss-animate.
  =============================================================================
*/
const styles = `
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes slideInRight {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }
  @keyframes slideInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes zoomIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }
  
  .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
  .animate-slide-right { animation: slideInRight 0.4s ease-out forwards; }
  .animate-slide-up { animation: slideInUp 0.5s ease-out forwards; }
  .animate-zoom-in { animation: zoomIn 0.3s ease-out forwards; }
  
  /* Кастомный скроллбар для красоты */
  .custom-scrollbar::-webkit-scrollbar { width: 6px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
`;

/* =============================================================================
  1. САМ КОМПОНЕНТ ВИЗАРДА (MODAL)
  =============================================================================
*/
const BathWizardModal = ({ isOpen, onClose }) => {
  const [currentStepId, setCurrentStepId] = useState('intro'); 
  const [history, setHistory] = useState([]); 
  const [selectedOption, setSelectedOption] = useState(null); 
  const [finalResult, setFinalResult] = useState(null); 

  // Сброс состояния при открытии
  useEffect(() => {
    if (isOpen) {
      setCurrentStepId('intro');
      setHistory([]);
      setFinalResult(null);
      setSelectedOption(null);
    }
  }, [isOpen]);

  if (!isOpen) return null;

  // --- ДАННЫЕ ---
  const steps = {
    intro: {
      id: 'intro',
      title: 'Find Your Perfect Bath',
      question: 'Answer 3 simple questions to find the safest and most comfortable bathing solution for your home.',
      isStart: true,
      buttonText: 'Start 30-Second Quiz'
    },
    step1: {
      id: 'step1',
      progress: 'Question 1 of 3',
      question: 'Who will be using the bath?',
      options: [
        { id: 'family', label: 'Whole Family', subLabel: 'Adults, children & seniors', icon: Users, action: 'result', resultId: 'shower-baths' },
        { id: 'senior', label: 'Just Me / Senior', subLabel: 'Need maximum safety & comfort', icon: User, action: 'next', nextStep: 'step2' }
      ]
    },
    step2: {
      id: 'step2',
      progress: 'Question 2 of 3',
      question: 'How do you prefer to bathe?',
      options: [
        { id: 'sitting', label: 'Seated (Upright)', subLabel: 'Difficult to lie down/get up', icon: Armchair, action: 'result', resultId: 'deep-soaker' },
        { id: 'lying', label: 'Lying Down / Reclined', subLabel: 'Like a traditional bath', icon: Bed, action: 'next', nextStep: 'step3' }
      ]
    },
    step3: {
      id: 'step3',
      progress: 'Question 3 of 3',
      question: 'Do you have specific access needs?',
      options: [
        { id: 'wheelchair', label: 'Wheelchair / Low Level', subLabel: 'Zero threshold entry required', icon: Accessibility, action: 'result', resultId: 'walk-in' },
        { id: 'standard', label: 'Standard Access', subLabel: 'Replacing a regular bath', icon: Box, action: 'result', resultId: 'standard' }
      ]
    }
  };

  const results = {
    'shower-baths': { 
      title: 'Walk-In Shower Baths', 
      subtitle: 'Level access, no stepping over', 
      description: 'The perfect 2-in-1 solution. Spacious showering area for the family with low-level entry for safety.', 
      urlParam: '?category=shower-baths', 
      imagePlaceholder: 'Shower Bath Image' 
    },
    'deep-soaker': { 
      title: 'Deep Soaker Baths', 
      subtitle: 'Ideal for small spaces', 
      description: 'Compact baths with a built-in seat. Allows for deep, relaxing immersion without the struggle of lying down.', 
      urlParam: '?category=deep-soakers', 
      imagePlaceholder: 'Deep Soaker Image' 
    },
    'walk-in': { 
      title: 'Walk-In Baths', 
      subtitle: 'Full length comfort & low threshold', 
      description: 'Classic full-length bathing with a watertight door. Easy entry without climbing over a high rim.', 
      urlParam: '?category=walk-in-baths', 
      imagePlaceholder: 'Walk-in Bath Image' 
    },
    'standard': { 
      title: 'Standard Size Baths', 
      subtitle: 'Accessible full-length bathing', 
      description: 'Fits into the space of your existing tub. Familiar comfort with the added safety of a door.', 
      urlParam: '?category=standard-baths', 
      imagePlaceholder: 'Standard Bath Image' 
    }
  };

  const handleStart = () => setCurrentStepId('step1');
  const handleOptionSelect = (option) => setSelectedOption(option);
  
  const handleNext = () => {
    if (!selectedOption) return;
    if (selectedOption.action === 'result') {
      setFinalResult(results[selectedOption.resultId]);
    } else {
      setHistory([...history, currentStepId]);
      setCurrentStepId(selectedOption.nextStep);
    }
    setSelectedOption(null);
  };

  const handleBack = () => {
    if (finalResult) {
      setFinalResult(null);
    } else if (history.length > 0) {
      const prevStep = history[history.length - 1];
      setHistory(history.slice(0, -1));
      setCurrentStepId(prevStep);
      setSelectedOption(null);
    } else {
      setCurrentStepId('intro');
    }
  };

  const currentStep = steps[currentStepId];

  return (
    <>
      <style>{styles}</style>
      
      {/* ОВЕРЛЕЙ: Анимация animate-fade-in */}
      <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-fade-in">
        
        {/* КОНТЕЙНЕР: Анимация animate-zoom-in */}
        <div className="relative w-full max-w-4xl bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-zoom-in">
          
          <button 
            onClick={onClose}
            className="absolute top-4 right-4 z-10 p-2 bg-white/50 hover:bg-slate-100 rounded-full text-slate-500 hover:text-slate-900 transition-colors duration-200"
          >
            <X size={24} />
          </button>

          <div className="overflow-y-auto custom-scrollbar">
            {finalResult ? (
              // ЭКРАН РЕЗУЛЬТАТА: animate-slide-up
              <div key="result" className="p-8 md:p-12 text-center animate-slide-up">
                <div className="bg-slate-100 h-48 md:h-64 w-full rounded-xl flex items-center justify-center relative mb-8 overflow-hidden group">
                   <div className="absolute inset-0 flex items-center justify-center bg-slate-200 text-slate-400 font-bold text-2xl group-hover:scale-105 transition-transform duration-700">
                      
                   </div>
                   <div className="absolute top-4 right-4 bg-white/90 px-3 py-1 rounded-full shadow-sm flex items-center gap-1 animate-zoom-in">
                      <Star size={14} className="text-green-500" fill="currentColor" />
                      <span className="text-xs font-bold text-slate-800">Best Match</span>
                   </div>
                </div>
                <h2 className="text-3xl font-extrabold text-slate-900 mb-2">{finalResult.title}</h2>
                <p className="text-teal-700 font-medium text-lg mb-4">{finalResult.subtitle}</p>
                <p className="text-slate-600 mb-8 leading-relaxed max-w-lg mx-auto">{finalResult.description}</p>
                <div className="space-y-4">
                  <button onClick={() => alert(`Redirecting to: ${finalResult.urlParam}`)} className="w-full bg-slate-900 hover:bg-slate-800 text-white text-xl font-bold py-4 px-8 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                    View These Models
                  </button>
                  <button onClick={handleBack} className="text-slate-400 font-medium hover:text-teal-700 text-sm transition-colors duration-200">Start Over</button>
                </div>
              </div>
            ) : currentStep.isStart ? (
              // ЭКРАН ИНТРО: animate-slide-up
              <div key="intro" className="p-12 md:p-16 text-center animate-slide-up">
                <div className="inline-flex items-center justify-center w-16 h-16 bg-teal-50 rounded-full mb-6 text-teal-700 animate-zoom-in">
                   <HelpCircle size={32} />
                </div>
                <h2 className="text-3xl md:text-5xl font-extrabold text-slate-900 mb-6">{currentStep.title}</h2>
                <p className="text-xl text-slate-600 mb-10 max-w-xl mx-auto">{currentStep.question}</p>
                <button onClick={handleStart} className="bg-teal-700 hover:bg-teal-800 text-white text-2xl font-bold py-4 px-12 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300">
                  {currentStep.buttonText}
                </button>
                <div className="mt-6 text-slate-400 text-sm flex justify-center gap-2"><Phone size={14} /> Need help? Call 0800 123 4567</div>
              </div>
            ) : (
              // ЭКРАН ВОПРОСА: animate-slide-right (появляется справа)
              <div key={currentStepId} className="flex flex-col min-h-[500px] animate-slide-right">
                <div className="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                  <span className="text-teal-700 font-bold text-sm uppercase tracking-widest">{currentStep.progress}</span>
                  <div className="flex gap-2">
                     {/* Плавный прогресс бар */}
                     {['step1', 'step2', 'step3'].map((step, idx) => (
                       <div key={step} className={`h-2 rounded-full transition-all duration-500 ease-out ${currentStepId === step || idx < ['step1', 'step2', 'step3'].indexOf(currentStepId) ? 'w-8 bg-teal-600' : 'w-2 bg-slate-200'}`}></div>
                     ))}
                  </div>
                </div>

                <div className="p-6 md:p-12 flex-grow bg-slate-50/50">
                  <h2 className="text-3xl font-extrabold text-slate-900 mb-10 text-center leading-tight">{currentStep.question}</h2>
                  <div className="grid md:grid-cols-2 gap-6">
                    {currentStep.options.map((option) => {
                      const Icon = option.icon;
                      const isSelected = selectedOption?.id === option.id;
                      return (
                        <div 
                          key={option.id} 
                          onClick={() => handleOptionSelect(option)}
                          // Ховер эффекты (стандартный tailwind)
                          className={`
                            cursor-pointer p-8 rounded-xl border-2 transition-all duration-200 text-left bg-white group
                            ${isSelected 
                              ? 'border-teal-600 shadow-xl ring-1 ring-teal-600 transform scale-[1.02]' 
                              : 'border-transparent shadow-md hover:border-teal-200 hover:shadow-lg hover:scale-[1.01]'
                            }
                          `}
                        >
                          <div className="flex justify-between mb-4">
                             <div className={`p-3 rounded-lg transition-colors duration-300 ${isSelected ? 'bg-teal-100 text-teal-800' : 'bg-slate-100 text-slate-500 group-hover:bg-teal-50 group-hover:text-teal-600'}`}>
                               <Icon size={32} />
                             </div>
                             {/* Галочка появляется с zoom-in */}
                             <div className={`transition-all duration-300 ${isSelected ? 'opacity-100 scale-100' : 'opacity-0 scale-50'}`}>
                               <CheckCircle className="text-teal-600" size={24} fill="currentColor" color="white" />
                             </div>
                          </div>
                          <h3 className="text-xl font-bold text-slate-900 mb-2">{option.label}</h3>
                          <p className="text-base text-slate-500">{option.subLabel}</p>
                        </div>
                      );
                    })}
                  </div>
                </div>

                <div className="p-8 border-t border-slate-100 flex justify-between bg-white sticky bottom-0">
                    <button onClick={handleBack} className="flex items-center gap-2 text-slate-500 hover:text-slate-900 font-bold px-4 py-2 hover:bg-slate-50 rounded-lg transition-colors duration-200">
                      <ArrowLeft size={20} /> Back
                    </button>
                    <button 
                      onClick={handleNext} 
                      disabled={!selectedOption} 
                      className={`
                        flex items-center gap-2 text-lg font-bold py-3 px-8 rounded-lg shadow-md transition-all duration-300
                        ${selectedOption 
                          ? 'bg-teal-700 hover:bg-teal-800 text-white transform hover:-translate-y-1' 
                          : 'bg-slate-200 text-slate-400 cursor-not-allowed'
                        }
                      `}
                    >
                      Continue <ArrowRight size={20} />
                    </button>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </>
  );
};

/* =============================================================================
  2. ТЕСТОВЫЙ ЭКРАН (PREVIEW)
  =============================================================================
*/
export default function BathWizardPreview() {
  const [isWizardOpen, setIsWizardOpen] = useState(false); 

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
      <header className="border-b border-slate-200 py-4 px-8 flex items-center justify-between sticky top-0 bg-white z-10 shadow-sm">
        <div className="flex items-center gap-2">
           <div className="w-10 h-10 bg-teal-700 rounded-full flex items-center justify-center text-white font-bold">O</div>
           <span className="text-2xl font-bold text-slate-900">ODYSSEY</span>
        </div>
        <div className="flex items-center gap-4">
          <button 
             onClick={() => setIsWizardOpen(true)}
             className="hidden md:flex items-center gap-2 bg-teal-50 text-teal-800 border-2 border-teal-100 hover:border-teal-200 font-bold py-2 px-4 rounded-lg transition-all"
          >
             <HelpCircle size={18} />
             <span>Help Me Choose</span>
          </button>
          <button className="p-2 border border-slate-200 rounded text-slate-600"><Menu size={24} /></button>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-8 py-24 text-center">
         <div className="mb-12">
            <h1 className="text-5xl font-extrabold text-slate-900 mb-6">Find Your Perfect Bath</h1>
            <p className="text-xl text-slate-600 mb-8 max-w-2xl mx-auto leading-relaxed">
              Not sure which model is right for you? Take our quick interactive quiz to find the perfect match for your bathroom and mobility needs.
            </p>
            <button 
              onClick={() => setIsWizardOpen(true)}
              className="bg-teal-700 hover:bg-teal-800 text-white text-2xl font-bold py-5 px-12 rounded-xl shadow-xl transform hover:-translate-y-1 transition-all flex items-center gap-3 mx-auto"
            >
              <HelpCircle size={28} />
              Start Quiz
            </button>
         </div>

         <div className="mt-16 grid grid-cols-1 md:grid-cols-3 gap-6 opacity-30 pointer-events-none grayscale">
            {[1, 2, 3].map(i => (
              <div key={i} className="h-64 bg-white rounded-xl border border-slate-200 shadow-sm flex items-center justify-center">
                 <span className="text-slate-300 font-bold text-4xl">Bath {i}</span>
              </div>
            ))}
         </div>
      </main>

      <BathWizardModal 
        isOpen={isWizardOpen} 
        onClose={() => setIsWizardOpen(false)} 
      />
    </div>
  );
}